<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termo de Garantia Legal - MiPlace</title>
    <!-- Incluindo o script do Tailwind CSS para estiliza√ß√£o r√°pida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Utilizando fontes do Google Fonts para o visual Vintage/Contrato -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@600&family=Lora:ital,wght@0,400;0,700;1,400;1,700&family=Rye&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Lora', serif; /* Fonte cl√°ssica para o corpo do texto */
        }
        
        .vintage-title {
            font-family: 'Rye', serif; /* Fonte estilo Velho Oeste / Contrato Antigo */
            letter-spacing: 0.05em;
        }

        /* Efeito de papel antigo com leve ru√≠do */
        .paper-bg {
            background-color: #f5eedc;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.06'/%3E%3C/svg%3E");
            color: #2c241b;
        }

        /* Estilo dos campos de entrada parecendo preenchimento √† m√£o */
        .vintage-input {
            background-color: transparent !important;
            border: none !important;
            border-bottom: 2px dotted #78716c !important; /* stone-500 */
            border-radius: 0 !important;
            box-shadow: none !important;
            font-family: 'Caveat', cursive !important;
            font-size: 1.45rem !important;
            color: #1c1914 !important;
            padding: 0.1rem 0.5rem !important;
            line-height: 1 !important;
        }
        .vintage-input:focus {
            outline: none !important;
            border-bottom: 2px solid #292524 !important; /* stone-800 */
            background-color: rgba(0,0,0,0.02) !important;
        }
        .vintage-input:disabled {
            color: #a8a29e !important;
            border-bottom: 2px dotted #d6d3d1 !important;
        }
        .vintage-input::placeholder {
            font-family: 'Lora', serif;
            font-size: 0.95rem;
            color: #a8a29e;
            font-style: italic;
        }

        .signature-line {
            border-bottom: 2px dashed #443c33;
        }

        /* Estilos para campos inv√°lidos */
        .invalid-field {
            border-bottom: 2px solid #ef4444 !important;
            background-color: rgba(239, 68, 68, 0.05) !important;
        }

        /* Ocultar a setinha padr√£o do datalist para ficar mais limpo */
        input::-webkit-calendar-picker-indicator {
            opacity: 0.5;
            cursor: pointer;
        }

        /* Estilos espec√≠ficos para impress√£o */
        @media print {
            @page {
                size: A4;
                margin: 5mm 10mm 5mm 10mm; /* Margens reduzidas: Top Right Bottom Left */
            }
            body {
                background-color: #fff !important;
                margin: 0;
                padding: 0;
                color: #000;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print {
                display: none !important;
            }
            .paper-bg {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                background-image: none !important; /* Remove ru√≠do de fundo para impress√£o mais limpa */
                background-color: transparent !important;
            }
            
            .force-page-break {
                page-break-before: always !important;
                break-before: page !important;
                margin-top: 0 !important;
                padding-top: 0 !important;
            }

            /* --- OTIMIZA√á√ÉO GERAL DE ESPA√áO --- */
            
            /* Cabe√ßalho Compacto */
            h1#main-title { 
                font-size: 16pt !important; 
                margin-bottom: 2px !important;
                margin-top: 0 !important;
                line-height: 1.1 !important;
            }
            img#logo-image { 
                width: 50px !important; 
                height: 50px !important; 
                margin-bottom: 0 !important; 
                margin-right: 10px !important;
            }
            #miplace-info {
                margin-top: 0 !important;
                margin-bottom: 5px !important;
                font-size: 9pt !important;
            }
            
            /* Redu√ß√£o de gaps e margens gerais */
            .mb-10 { margin-bottom: 5px !important; }
            .mb-8 { margin-bottom: 5px !important; }
            .mb-6 { margin-bottom: 3px !important; }
            .mb-5 { margin-bottom: 3px !important; }
            .mb-4 { margin-bottom: 2px !important; }
            .mt-12 { margin-top: 5px !important; }
            .mt-10 { margin-top: 5px !important; }
            .mt-8 { margin-top: 5px !important; }
            .gap-6 { gap: 5px !important; }
            .pt-6 { padding-top: 5px !important; }
            .pb-8 { padding-bottom: 5px !important; }
            
            /* Fontes gerais menores */
            p, ul, label, li { font-size: 8.5pt !important; line-height: 1.2 !important; }
            .text-sm { font-size: 8.5pt !important; }
            .text-xs { font-size: 7.5pt !important; }
            
            /* Inputs compactos */
            .vintage-input {
                font-size: 9pt !important;
                border-bottom: 1px solid #000 !important;
                color: #000 !important;
                padding: 0 !important;
                height: auto !important;
                margin-bottom: 0 !important;
            }
            select {
                border: none !important;
                padding: 0 !important;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                background-image: none;
            }

            /* --- OTIMIZA√á√ÉO IPHONE / SEMINOVO (TEXTOS LONGOS) --- */
            
            /* Texto ultra compacto para garantir 1 p√°gina */
            #content-iphone p, #content-iphone li, 
            #content-seminovo p, #content-seminovo li {
                font-size: 7.5pt !important; 
                line-height: 1.15 !important;
                margin-bottom: 2px !important;
                text-align: justify !important;
            }
            
            #content-iphone strong, #content-seminovo strong {
                font-size: 7.5pt !important;
            }

            /* T√≠tulos das cl√°usulas */
            #content-iphone h2, #content-seminovo h2 {
                font-size: 8.5pt !important;
                margin-top: 6px !important;
                margin-bottom: 2px !important;
                padding-bottom: 1px !important;
                border-bottom-width: 1px !important;
            }
            
            /* Listas */
            .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 3px !important; }
            .space-y-2 > :not([hidden]) ~ :not([hidden]) { margin-top: 1px !important; }
            ul { margin-bottom: 2px !important; }

            /* Declara√ß√£o final e assinatura */
            #declaration-text {
                margin-top: 5px !important;
                padding-top: 5px !important;
                font-size: 8pt !important;
            }
            .signature-line {
                margin-bottom: 5px !important;
                border-bottom: 1px solid #000 !important;
            }
            
            /* Rodap√© Contato */
            #support-phone { font-size: 10pt !important; }
            
            /* --- P√ÅGINA 2 (NOTA FISCAL) --- */
            
            /* T√≠tulo NF */
            h2.vintage-title { font-size: 14pt !important; margin-bottom: 10px !important; margin-top: 0 !important; }
            
            /* Acess√≥rios compactos */
            .accessory-row {
                padding-bottom: 2px !important;
                margin-bottom: 2px !important;
                border-bottom: none !important; /* Remove linha extra para economizar espa√ßo se tiver muitos */
            }
            #accessories-container {
                display: grid;
                grid-template-columns: 1fr;
                gap: 2px !important;
            }
        }
    </style>
</head>
<body class="bg-stone-900 p-4 md:p-10 font-serif text-stone-900 antialiased selection:bg-stone-300">

    <div class="max-w-4xl mx-auto">
        <!-- Tabs de Navega√ß√£o -->
        <div class="flex space-x-4 mb-6 no-print">
            <button id="tab-btn-new" class="flex-1 py-3 px-4 bg-stone-800 text-[#d6cfb8] rounded-t-lg font-bold border-b-2 border-[#d6cfb8] hover:bg-stone-700 transition-colors uppercase tracking-widest flex items-center justify-center gap-2">
                üìù Novo Termo
            </button>
            <button id="tab-btn-history" class="flex-1 py-3 px-4 bg-stone-900 text-stone-500 rounded-t-lg font-bold border-b-2 border-stone-700 hover:bg-stone-800 hover:text-stone-300 transition-colors uppercase tracking-widest flex items-center justify-center gap-2">
                üóÇÔ∏è Hist√≥rico Di√°rio
            </button>
        </div>

        <!-- Conte√∫do da Tab: NOVO TERMO -->
        <div id="tab-content-new">
            <!-- Se√ß√£o: SELE√á√ÉO DE TIPO DE TERMO (Painel de Controle Flutuante) -->
            <div class="mb-8 p-6 bg-stone-800 rounded-xl shadow-[0_10px_30px_rgba(0,0,0,0.8)] border border-stone-700 relative overflow-hidden no-print">
                <div class="absolute top-0 right-0 w-32 h-32 bg-stone-700 rounded-full blur-3xl opacity-20 -mr-10 -mt-10"></div>
                <label for="term-type" class="block text-xs font-bold text-stone-400 mb-2 uppercase tracking-widest font-sans">‚öôÔ∏è Configura√ß√£o do Documento</label>
                <select id="term-type" class="w-full px-4 py-3 border border-stone-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-stone-400 bg-stone-900 text-stone-100 font-sans font-semibold shadow-inner transition-all cursor-pointer">
                    <option value="standard">Linha Android Novo</option>
                    <option value="iphone">iPhone Lacrado Garantia Apple</option>
                    <option value="seminovo">iPhone Semi-novos</option>
                </select>
            </div>

            <!-- FOLHA 1: O PAPEL DO CONTRATO -->
            <div class="paper-bg p-8 md:p-16 rounded shadow-[0_20px_50px_rgba(0,0,0,0.5)] border border-[#d6cfb8] relative mb-12 print:mb-0">
                
                <!-- Se√ß√£o: TERMO DE GARANTIA LEGAL -->
                <div class="mb-10">
                    <!-- T√≠tulo com o logo ao lado esquerdo -->
                    <div class="text-center mb-2 flex flex-col md:flex-row items-center justify-center">
                        <img id="logo-image" src="https://placehold.co/120x80/d1d5db/4b5563?text=Logo" alt="Placeholder para logo da loja" class="w-24 h-24 rounded-full border border-stone-800 p-1 mb-4 md:mb-0 md:mr-6 object-cover">
                        <h1 id="main-title" class="text-3xl md:text-5xl font-normal text-stone-900 vintage-title text-center leading-tight">
                            TERMO DE GARANTIA LEGAL
                        </h1>
                    </div>
                    <p id="miplace-info" class="text-center text-sm md:text-base text-stone-700 mt-2 tracking-widest uppercase font-bold">
                        MiPlace
                    </p>
                    
                    <!-- Divisor Ornamental Vintage -->
                    <div class="flex justify-center my-6 opacity-70">
                        <svg width="250" height="24" viewBox="0 0 250 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M125 12 C 125 12 95 0 65 12 C 45 20 20 12 0 12" stroke="#443c33" stroke-width="1.5" fill="none"/>
                            <path d="M125 12 C 125 12 155 0 185 12 C 205 20 230 12 250 12" stroke="#443c33" stroke-width="1.5" fill="none"/>
                            <circle cx="125" cy="12" r="3" fill="#443c33"/>
                            <circle cx="125" cy="12" r="6" stroke="#443c33" stroke-width="1" fill="none"/>
                        </svg>
                    </div>

                    <!-- Nova se√ß√£o para Dados da Venda e do Comprador -->
                    <div class="mb-8 pb-8 border-b border-stone-400 border-dashed no-print">
                        <div class="flex items-center gap-4 mb-5">
                            <h3 class="text-xs font-bold text-stone-800 uppercase tracking-widest border-l-4 border-stone-800 pl-2 m-0">Informa√ß√µes da Venda e do Comprador</h3>
                            <div class="transform -rotate-12 border-2 border-red-800 px-3 py-1 rounded mix-blend-multiply opacity-60">
                                <p class="font-bold text-red-800 text-xs tracking-[0.2em] uppercase vintage-title">Authentic</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-6 text-sm mb-6">
                            <div class="flex flex-col">
                                <label for="purchase-location" class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Local da compra</label>
                                <select id="purchase-location" name="purchase-location" class="vintage-input w-full js-required cursor-pointer">
                                    <option value="">Selecione o local da compra</option>
                                    <option value="Miplace Honor, Rua Dom Pedro II, 857 centro Piracicaba CNPJ 34511185/0001-10">Miplace Honor, Rua Dom Pedro II, 857 centro Piracicaba CNPJ 34511185/0001-10</option>
                                    <option value="Miplace Realme, Rua Benjamin Constant, 1230 centro Piracicaba CNPJ 44739622/0001-01">Miplace Realme, Rua Benjamin Constant, 1230 centro Piracicaba CNPJ 44739622/0001-01</option>
                                    <option value="Miplace XV, Rua XV de Novembro, 910 centro Piracicaba CNPJ 13787408/0001-05">Miplace XV, Rua XV de Novembro, 910 centro Piracicaba CNPJ 13787408/0001-05</option>
                                    <option value="Miplace Premium, Rua Treze de Maio, 26 centro Amparo CNPJ 58186781/0001-30">Miplace Premium, Rua Treze de Maio, 26 centro Amparo CNPJ 58186781/0001-30</option>
                                    <option value="Miplace Kassouf, Rua Treze de Maio 218 Sala 9, centro Amparo CNPJ 58495100/0001-16">Miplace Kassouf, Rua Treze de Maio 218 Sala 9, centro Amparo CNPJ 58495100/0001-16</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 print:grid-cols-4 gap-6 text-sm">
                            <div class="flex flex-col md:col-span-2 print:col-span-2">
                                <label for="buyer-name" class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Nome do Comprador</label>
                                <input type="text" id="buyer-name" name="buyer-name" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col">
                                <label for="cpf" class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">CPF</label>
                                <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" maxlength="14" inputmode="numeric" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col">
                                <label for="how-knew" class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Conheceu a loja</label>
                                <input list="how-knew-options" id="how-knew" name="how-knew" placeholder="Selecione a loja primeiro" class="vintage-input w-full js-required" disabled>
                                <datalist id="how-knew-options">
                                </datalist>
                            </div>
                        </div>
                    </div>

                    <!-- CONTE√öDO PADR√ÉO (Multimarcas) -->
                    <div id="content-standard" class="text-stone-900 leading-relaxed text-justify">
                        <p class="mb-4">
                            A MiPlace concede a presente garantia aos smartphones comercializados, em conformidade com as disposi√ß√µes da Lei n¬∫ 8.078/90 do C√≥digo de Defesa do Consumidor (CDC), garantindo ao consumidor cobertura contra defeitos de fabrica√ß√£o dentro dos prazos estabelecidos para cada marca.
                        </p>

                        <p class="mb-6">
                            A garantia legal √© de <strong class="font-bold">90 (noventa) dias</strong> a partir da data da compra, conforme determina o artigo 26, inciso II, do CDC. Para marcas que oferecem garantia adicional com o fabricante, a responsabilidade da MiPlace se limita aos primeiros 90 dias, sendo o per√≠odo restante de responsabilidade exclusiva de cada fabricante, conforme artigo 18 do CDC.
                        </p>

                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">Prazos de Garantia por Marca</h2>
                        <ul class="list-disc pl-5 space-y-2 mb-6 text-stone-800">
                            <li><strong>Xiaomi, Redmi e Poco:</strong> <strong>90 (noventa) dias</strong> de garantia exclusiva pela MiPlace.</li>
                            <li><strong>Realme, Samsung e Motorola:</strong> Garantia total de <strong>1 (um) ano</strong>. Os primeiros <strong>3 meses</strong> s√£o de responsabilidade da MiPlace e os 9 meses restantes de responsabilidade do fabricante.</li>
                            <li><strong>Honor:</strong> Garantia total de <strong>2 (dois) anos</strong>. Os primeiros <strong>3 meses</strong> s√£o cobertos pela MiPlace e o per√≠odo restante (1 ano e 9 meses) √© de responsabilidade do fabricante.</li>
                        </ul>

                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">Exclus√µes da Garantia</h2>
                        <p class="mb-4 text-stone-800">
                            A garantia n√£o cobre avarias decorrentes de <strong>mau uso, quedas, contato com l√≠quidos, sobrecarga el√©trica, interven√ß√£o t√©cnica n√£o autorizada</strong> ou qualquer outro dano acidental.
                        </p>

                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">Processo de Acionamento</h2>
                        <p class="mb-4 text-stone-800">
                            Para acionar a garantia, o consumidor dever√° apresentar o termo de garantia e encaminhar o produto para an√°lise t√©cnica. A MiPlace tem at√© <strong>30 (trinta) dias</strong> para an√°lise e eventual reparo, substitui√ß√£o ou reembolso a partir da data que o consumidor reportar o defeito do aparelho.
                        </p>
                        <p class="mt-2 text-stone-800">
                            Este termo de garantia n√£o exclui nem restringe os direitos assegurados ao consumidor pela legisla√ß√£o vigente. Para mais informa√ß√µes, o consumidor poder√° entrar em contato com a Miplace por meio dos canais de atendimento dispon√≠veis, incluindo e-mail, telefone ou presencialmente em loja.
                        </p>
                    </div>

                    <!-- CONTE√öDO IPHONE LACRADO (Apple) - Inicialmente Oculto -->
                    <div id="content-iphone" class="hidden text-stone-900 leading-relaxed text-justify">
                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">CL√ÅUSULA PRIMEIRA - DA GARANTIA E RESPONSABILIDADE DO FABRICANTE</h2>
                        <ul class="list-none space-y-4 mb-6">
                            <li>
                                <strong>1.1. Garantia Mundial Apple:</strong> Por tratar-se de um produto novo e lacrado, a garantia √© fornecida diretamente pela fabricante (Apple Inc.), com validade de 01 (um) ano a partir da data de ativa√ß√£o do dispositivo no sistema da Apple.
                            </li>
                            <li>
                                <strong>1.2. Responsabilidade Exclusiva do Fabricante:</strong> A MiPlace atua estritamente como comercializadora do produto lacrado. Qualquer defeito de fabrica√ß√£o, v√≠cio de hardware ou falha de software deve ser tratado diretamente com o Suporte Oficial da Apple, que possui a responsabilidade integral pela cobertura e solu√ß√£o t√©cnica.
                            </li>
                            <li>
                                <strong>1.3. Abrang√™ncia:</strong> A garantia covers defeitos de fabrica√ß√£o e problemas de hardware conforme as diretrizes globais da Apple.
                            </li>
                        </ul>

                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">CL√ÅUSULA SEGUNDA - DA CONDI√á√ÉO DO PRODUTO E ATIVA√á√ÉO</h2>
                        <ul class="list-none space-y-4 mb-6">
                            <li>
                                <strong>2.1. Produto Lacrado:</strong> O Consumidor declara ter recebido o produto em sua embalagem original, devidamente lacrada, confirmando a integridade da caixa no ato da entrega.
                            </li>
                            <li>
                                <strong>2.2. Valida√ß√£o da Garantia:</strong> A valida√ß√£o do per√≠odo de garantia √© realizada eletronicamente atrav√©s do n√∫mero de s√©rie/IMEI do aparelho, registrando-se automaticamente no sistema da Apple no momento em que o aparelho √© ligado e conectado √† internet pela primeira vez (Ativa√ß√£o).
                            </li>
                        </ul>

                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">CL√ÅUSULA TERCEIRA - EXCLUS√ÉO E PERDA DA GARANTIA</h2>
                        <ul class="list-none space-y-4 mb-6">
                            <li>
                                <strong>3.1.</strong> A garantia da Apple ser√° automaticamente anulada se o produto sofrer danos acidentais n√£o cobertos (como telas quebradas, contato com l√≠quidos ou carca√ßa amassada), salvo se o cliente possuir cobertura adicional AppleCare+ contratada √† parte.
                            </li>
                            <li>
                                <strong>3.2. Proibi√ß√£o de Interven√ß√£o T√©cnica:</strong> A garantia ser√° anulada imediatamente caso o aparelho seja aberto, analisado ou reparado por qualquer assist√™ncia t√©cnica n√£o autorizada pela Apple, incluindo a pr√≥pria loja MiPlace. O produto n√£o deve sofrer interven√ß√£o de terceiros sob nenhuma hip√≥tese.
                            </li>
                            <li>
                                <strong>3.3. Softwares n√£o Oficiais:</strong> A tentativa de desbloqueios (jailbreak) ou modifica√ß√µes profundas no sistema operacional iOS anula o suporte e a garantia do fabricante.
                            </li>
                        </ul>

                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">CL√ÅUSULA QUARTA - PROCEDIMENTO PARA ACIONAMENTO</h2>
                        <ul class="list-none space-y-4 mb-6">
                            <li>
                                <strong>4.1. Canal de Atendimento:</strong> Em caso de defeito o acionamento deve ser feito diretamente com a Apple Brasil atrav√©s do telefone 0800-761-0880 ou pelo site oficial (support.apple.com), agendando atendimento em uma Apple Store ou Centro de Servi√ßo Autorizado (AASP).
                            </li>
                            <li>
                                <strong>4.2. Isen√ß√£o da Loja:</strong> A MiPlace n√£o realiza an√°lise t√©cnica ou reparos em aparelhos novos/lacrados, a fim de preservar a garantia original do cliente junto ao fabricante.
                            </li>
                        </ul>

                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">CL√ÅUSULA QUINTA - DA GEST√ÉO DA CONTA E SENHA PESSOAL</h2>
                        <p class="mb-6">
                            <strong>5.1.</strong> A senha e a conta iCloud s√£o de responsabilidade exclusiva do cliente, que as define no momento da ativa√ß√£o. A MiPlace n√£o insere, armazena ou altera senhas. Qualquer bloqueio ou perda de acesso deve ser resolvido diretamente com o suporte da Apple, n√£o havendo responsabilidade da loja por esquecimento, gerenciamento da conta ou recupera√ß√£o de acesso.
                        </p>

                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">CL√ÅUSULA SEXTA - DISPOSI√á√ïES FINAIS</h2>
                        <ul class="list-none space-y-4 mb-6">
                            <li>
                                <strong>6.1.</strong> O presente termo visa esclarecer o fluxo de garantia direta com o fabricante, assegurando ao consumidor o acesso a pe√ßas originais e servi√ßo autorizado.
                            </li>
                            <li>
                                <strong>6.2. Suporte:</strong> A MiPlace permanece √† disposi√ß√£o para orientar o cliente sobre como localizar os canais de contato da Apple, caso necess√°rio.
                            </li>
                        </ul>
                    </div>

                    <!-- CONTE√öDO IPHONE SEMI-NOVO - Inicialmente Oculto -->
                    <div id="content-seminovo" class="hidden text-stone-900 leading-relaxed text-justify">
                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">CL√ÅUSULA PRIMEIRA - PRAZO DA GARANTIA E COBERTURA DA LOJA</h2>
                        <ul class="list-none space-y-4 mb-6">
                            <li>
                                <strong>1.1. Garantia Legal:</strong> A garantia contra defeitos de fabrica√ß√£o para iPhones Semi-Novos √© estipulada em 90 (noventa) dias corridos, a partir da data de compra.
                            </li>
                            <li>
                                <strong>1.2. Responsabilidade Exclusiva da Loja:</strong> Durante este prazo de 90 (noventa) dias, a MiPlace assume integralmente a responsabilidade pela cobertura de defeitos de fabrica√ß√£o que comprometam o uso adequado do aparelho.
                            </li>
                            <li>
                                <strong>1.3. Abrang√™ncia:</strong> A garantia √© limitada a defeitos de hardware (pe√ßas) e funcionamento que sejam comprovadamente de origem t√©cnica, manifestados durante o uso normal do aparelho.
                            </li>
                        </ul>

                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">CL√ÅUSULA SEGUNDA - DA NATUREZA E CONDI√á√ÉO DO PRODUTO SEMI-NOVO</h2>
                        <ul class="list-none space-y-4 mb-6">
                            <li>
                                <strong>2.1. Aus√™ncia de Lacre Original:</strong> O Consumidor declara estar ciente e de acordo que o produto adquirido trata-se de um dispositivo SEMI-NOVO, comercializado fora de sua embalagem lacrada original de f√°brica.
                            </li>
                            <li>
                                <strong>2.2. Hist√≥rico e Manuten√ß√µes Pr√©vias:</strong> Em raz√£o de n√£o se ter conhecimento integral sobre o hist√≥rico de uso dos propriet√°rios anteriores, o Consumidor reconhece que o aparelho pode ter sido submetido a procedimentos de abertura de chassi, manuten√ß√µes ou substitui√ß√£o de pe√ßas/componentes internos.
                            </li>
                            <li>
                                <strong>2.3. Aceite da Condi√ß√£o:</strong> O Consumidor aceita adquirir o bem no estado em que se encontra, incluindo a entrega do iPhone resetado, sem senha e sem v√≠nculo com conta iCloud, ciente da possibility de exist√™ncia de pe√ßas de reposi√ß√£o, n√£o caracterizando tais fatos como v√≠cio oculto.
                            </li>
                        </ul>

                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">CL√ÅUSULA TERCEIRA - EXCLUS√ÉO E PERDA DA GARANTIA</h2>
                        <div class="mb-6">
                            <p class="mb-3"><strong>3.1.</strong> A presente garantia n√£o abrange, sob nenhuma hip√≥tese, avarias decorrentes de:</p>
                            <ul class="list-disc pl-5 space-y-2 mb-4">
                                <li>Mau uso ou desgaste natural do produto;</li>
                                <li>Quedas ou impactos;</li>
                                <li>Contato com l√≠quidos (dano por umidade);</li>
                                <li>Sobrecarga el√©trica ou varia√ß√µes de energia;</li>
                                <li>Interven√ß√£o t√©cnica n√£o autorizada (abertura, reparo ou modifica√ß√£o do aparelho por terceiros n√£o credenciados);</li>
                                <li>Qualquer outra situa√ß√£o que caracterize dano acidental ou uso inadequado.</li>
                            </ul>
                            <p class="mb-3"><strong>3.2.</strong> A viola√ß√£o dos selos/lacres de garantia da MiPlace ou o manuseio indevido, incluindo tentativa de jailbreak, atualiza√ß√µes beta ou altera√ß√£o de software de forma n√£o oficial, anula imediatamente a garantia.</p>
                            <p><strong>3.3.</strong> A garantia n√£o cobre a perda de dados, sendo de inteira responsabilidade do consumidor manter backups regulares de suas informa√ß√µes (iCloud/Computador).</p>
                        </div>

                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">CL√ÅUSULA QUARTA - PROCEDIMENTO E PRAZOS</h2>
                        <ul class="list-none space-y-4 mb-6">
                            <li>
                                <strong>4.1. Acionamento:</strong> Para acionar a garantia, o consumidor dever√° apresentar este termo, encaminhando o produto √† MiPlace para an√°lise t√©cnica.
                            </li>
                            <li>
                                <strong>4.2. Prazo de Solu√ß√£o:</strong> Nos termos do artigo 18, ¬ß1¬∫ do C√≥digo de Defesa do Consumidor (CDC), a MiPlace disp√µe do prazo legal de at√© 30 (trinta) dias para realizar a an√°lise t√©cnica e sanar o v√≠cio apresentado no produto.
                            </li>
                        </ul>

                        <h2 class="text-lg font-bold text-stone-900 mb-3 border-b border-stone-400 border-dashed pb-2 font-serif uppercase tracking-wide mt-8">CL√ÅUSULA QUINTA - DISPOSI√á√ïES FINAIS</h2>
                        <ul class="list-none space-y-4 mb-6">
                            <li>
                                <strong>5.1.</strong> Este termo de garantia n√£o exclui nem restringe os direitos assegurados ao consumidor pela legisla√ß√£o vigente.
                            </li>
                            <li>
                                <strong>5.2. Suporte e Contato:</strong> Para mais informa√ß√µes ou para acionar a garantia, o consumidor poder√° entrar em contato com a MiPlace atrav√©s de seus canais oficiais de atendimento e redes sociais.
                            </li>
                        </ul>
                    </div>

                    <!-- Declara√ß√£o Final Din√¢mica -->
                    <div id="declaration-text" class="text-base text-stone-800 mt-6 border-t border-stone-400 border-dashed pt-6 italic">
                         <!-- O texto aqui ser√° inserido pelo JS -->
                    </div>

                    <!-- Se√ß√£o de assinatura -->
                    <div class="mt-10 pt-4 text-base">
                        <p class="text-stone-800 font-bold mb-8 text-center uppercase tracking-widest">In Witness Whereof, a ci√™ncia das informa√ß√µes acima,</p>
                        <div class="signature-line w-full h-8 mb-4"></div>
                        <div class="flex justify-between items-end mt-4 w-full">
                            <div class="flex flex-col w-[45%] md:w-1/3">
                                <label for="date" class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Data da Compra</label>
                                <input type="text" id="date" name="date" placeholder="dd/mm/yyyy" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col w-[45%] md:w-1/3">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1 text-right">Conheceu a Miplace</label>
                                <input type="text" id="display-how-knew" class="vintage-input w-full bg-transparent text-stone-800 pointer-events-none text-right" readonly tabindex="-1">
                            </div>
                        </div>
                    </div>

                    <!-- Contato para Suporte com telefone din√¢mico -->
                    <div class="mt-12 pt-6 border-t border-stone-400 border-dashed relative">
                        <h3 class="text-sm font-bold text-stone-800 mb-2 uppercase tracking-widest">Contato para Suporte Oficial:</h3>
                        <p class="text-base text-stone-900 font-['Caveat'] text-2xl">
                            <span id="support-phone" class="font-bold"></span>
                        </p>

                        <!-- Selo Decorativo Final (N√£o imprime) -->
                        <div class="absolute bottom-0 right-4 opacity-70 transform -rotate-6 hidden md:block border-2 border-red-700 p-1.5 rounded-sm no-print mix-blend-multiply">
                            <p class="font-bold text-red-700 text-base tracking-widest uppercase vintage-title">MiPlace</p>
                            <p class="text-[7px] text-center uppercase font-bold tracking-widest border-t border-red-700 pt-0.5 mt-0.5 text-red-700">Selo de Garantia</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FOLHA 2: DADOS PARA EMISS√ÉO DE NOTA FISCAL -->
            <div class="paper-bg p-8 md:p-16 rounded shadow-[0_20px_50px_rgba(0,0,0,0.5)] border border-[#d6cfb8] relative force-page-break print:mt-0">
                
                <div>
                    <div class="flex justify-center mb-6 opacity-70">
                        <svg width="150" height="15" viewBox="0 0 150 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M0 7.5 H150" stroke="#443c33" stroke-width="2" stroke-dasharray="4 4"/>
                        </svg>
                    </div>
                    
                    <h2 class="text-center text-3xl font-normal text-stone-900 mb-8 vintage-title tracking-wide">DADOS PARA EMISS√ÉO DE NOTA FISCAL</h2>

                    <!-- Cabe√ßalho INFORMA√á√ïES DO CLIENTE -->
                    <div class="mb-8">
                        <h3 class="text-xs font-bold mb-5 text-stone-800 uppercase tracking-widest border-l-4 border-stone-800 pl-2">Informa√ß√µes do Cliente</h3>
                        
                        <!-- Linha 1: Nome e Telefone -->
                        <div class="grid grid-cols-1 md:grid-cols-4 print:grid-cols-4 gap-6 mb-5">
                            <div class="flex flex-col md:col-span-3 print:col-span-3">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Nome do Comprador</label>
                                <input type="text" id="nf-buyer-name" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col md:col-span-1 print:col-span-1">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Telefone</label>
                                <input type="text" id="nf-buyer-phone" placeholder="(00) 00000-0000" class="vintage-input w-full js-required">
                            </div>
                        </div>

                        <!-- Linha 2: Data Nascimento, Email, CPF -->
                        <div class="grid grid-cols-1 md:grid-cols-3 print:grid-cols-3 gap-6 mb-5">
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Data de Nascimento</label>
                                <input type="text" id="nf-birthdate-main" maxlength="10" placeholder="dd/mm/yyyy" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Email</label>
                                <input type="email" id="nf-email" placeholder="exemplo@email.com" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">CPF</label>
                                <input type="text" id="nf-cpf" placeholder="000.000.000-00" maxlength="14" inputmode="numeric" class="vintage-input w-full js-required">
                            </div>
                        </div>

                        <!-- Linha 3: Endere√ßo da Resid√™ncia, N√∫mero e Complemento -->
                        <div class="grid grid-cols-1 md:grid-cols-[10fr_3fr_7fr] print:grid-cols-[10fr_3fr_7fr] gap-6 mb-5">
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Endere√ßo da Resid√™ncia</label>
                                <input type="text" id="nf-address" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">N√∫mero</label>
                                <input type="text" id="nf-number" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Complemento</label>
                                <input type="text" id="nf-complement" placeholder="Opcional" class="vintage-input w-full">
                            </div>
                        </div>

                        <!-- Linha 4: Bairro, CEP, Cidade e Data da Compra -->
                        <div class="grid grid-cols-1 md:grid-cols-4 print:grid-cols-4 gap-6 mb-5">
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Bairro</label>
                                <input type="text" id="nf-neighborhood" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">CEP</label>
                                <input type="text" id="nf-zipcode" placeholder="00000-000" maxlength="9" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Cidade</label>
                                <input type="text" id="nf-city" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Data da Compra</label>
                                <input type="text" id="nf-purchase-date" placeholder="dd/mm/yyyy" maxlength="10" class="vintage-input w-full js-required">
                            </div>
                        </div>
                    </div>

                    <!-- Divisor -->
                    <div class="flex justify-center my-6 opacity-40">
                        <svg width="100" height="10" viewBox="0 0 100 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M0 5 H100" stroke="#443c33" stroke-width="1"/>
                        </svg>
                    </div>

                    <!-- Informa√ß√µes do Aparelho -->
                    <div>
                        <h3 class="text-xs font-bold mb-5 text-stone-800 uppercase tracking-widest border-l-4 border-stone-800 pl-2">Informa√ß√µes da Venda</h3>

                        <div class="grid grid-cols-1 md:grid-cols-12 print:grid-cols-12 gap-6 mb-5">
                            <div class="flex flex-col md:col-span-3 print:col-span-3">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Marca</label>
                                <select id="nf-brand" class="vintage-input w-full js-required cursor-pointer">
                                    <option value="">Selecione...</option>
                                    <option value="Honor">Honor</option>
                                    <option value="Iphone">Iphone</option>
                                    <option value="Motorola">Motorola</option>
                                    <option value="Poco">Poco</option>
                                    <option value="Realme">Realme</option>
                                    <option value="Redmi">Redmi</option>
                                    <option value="Samsung">Samsung</option>
                                </select>
                            </div>
                            <div class="flex flex-col md:col-span-5 print:col-span-5">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Modelo Celular</label>
                                <input type="text" id="nf-model" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col md:col-span-2 print:col-span-2">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">RAM/Storage</label>
                                <select id="nf-ram-storage" class="vintage-input w-full js-required cursor-pointer">
                                    <option value="">Selecione...</option>
                                    <option value="4/128">4/128</option>
                                    <option value="6/128">6/128</option>
                                    <option value="8/128">8/128</option>
                                    <option value="4/256">4/256</option>
                                    <option value="4/512">4/512</option>
                                    <option value="8/256">8/256</option>
                                    <option value="8/512">8/512</option>
                                    <option value="12/256">12/256</option>
                                    <option value="12/512">12/512</option>
                                    <option value="16/256">16/256</option>
                                    <option value="16/512">16/512</option>
                                    <option value="16/1TB">16/1TB</option>
                                </select>
                            </div>
                            <div class="flex flex-col md:col-span-2 print:col-span-2">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Cor</label>
                                <input type="text" id="nf-color" class="vintage-input w-full js-required">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 print:grid-cols-3 gap-6 mb-5">
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">IMEI</label>
                                <input type="text" id="nf-imei" maxlength="15" inputmode="numeric" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Valor do Aparelho</label>
                                <input type="text" id="nf-value" placeholder="R$ 0,00" class="vintage-input w-full js-required">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Forma de Pagamento</label>
                                <select id="nf-payment" class="vintage-input w-full js-required cursor-pointer">
                                    <option value="">Selecione...</option>
                                    <option value="Crefaz">Crefaz</option>
                                    <option value="Dinheiro">Dinheiro</option>
                                    <option value="Pix">Pix</option>
                                    <option value="Cr√©dito a vista">Cr√©dito a vista</option>
                                    <option value="Cr√©dito parcelado">Cr√©dito parcelado</option>
                                    <option value="D√©bito">D√©bito</option>
                                </select>
                            </div>
                        </div>

                        <!-- Se√ß√£o Acess√≥rios -->
                        <div class="mt-8">
                            <div class="flex items-center justify-between mb-5 border-l-4 border-stone-800 pl-2">
                                <h3 class="text-xs font-bold text-stone-800 uppercase tracking-widest">Acess√≥rios</h3>
                                <button type="button" id="add-accessory-btn" class="no-print bg-[#d6cfb8] text-stone-900 font-sans text-[10px] font-bold py-1 px-3 rounded hover:bg-[#c8c0a3] transition-all shadow-sm border border-[#a8a186] uppercase tracking-wider">
                                    + Adicionar Acess√≥rio
                                </button>
                            </div>
                            
                            <!-- Cont√™iner din√¢mico onde os acess√≥rios ser√£o inseridos -->
                            <div id="accessories-container" class="space-y-6">
                                <!-- Linhas de acess√≥rios injetadas pelo JS aparecer√£o aqui -->
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Mensagem de erro de valida√ß√£o (inicialmente oculta) -->
            <div id="validation-message" class="hidden mt-8 p-4 text-sm font-bold text-red-900 bg-red-100/90 backdrop-blur rounded border-2 border-red-800 border-dashed no-print text-center shadow-md font-sans">
                ‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios para poder imprimir.
            </div>

            <!-- Bot√µes de a√ß√£o com estilo cl√°ssico/stamp -->
            <div class="mt-10 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6 no-print">
                <button onclick="validateAndPrint()" class="bg-stone-800 text-stone-100 font-sans text-sm font-bold py-3 px-8 rounded hover:bg-stone-900 transition-all shadow-[0_5px_15px_rgba(0,0,0,0.4)] border border-stone-600 flex items-center justify-center uppercase tracking-widest">
                    üñ®Ô∏è Imprimir Termo
                </button>
                <button onclick="validateAndSave()" class="bg-stone-700 text-stone-100 font-sans text-sm font-bold py-3 px-8 rounded hover:bg-stone-600 transition-all shadow-[0_5px_15px_rgba(0,0,0,0.4)] border border-stone-500 flex items-center justify-center uppercase tracking-widest">
                    üíæ Salvar Termo
                </button>
                <button id="fill-date-btn" class="bg-[#d6cfb8] text-stone-900 font-sans text-sm font-bold py-3 px-8 rounded hover:bg-[#c8c0a3] transition-all shadow-[0_5px_15px_rgba(0,0,0,0.4)] border border-[#a8a186] flex items-center justify-center uppercase tracking-widest">
                    üìÖ Data de Hoje
                </button>
                <button id="clear-btn" class="bg-red-900 text-stone-100 font-sans text-sm font-bold py-3 px-8 rounded hover:bg-red-950 transition-all shadow-[0_5px_15px_rgba(0,0,0,0.4)] border border-red-800 flex items-center justify-center uppercase tracking-widest">
                    ‚úñ Limpar
                </button>
            </div>
        </div>
        
        <!-- Conte√∫do da Tab: HIST√ìRICO -->
        <div id="tab-content-history" class="hidden no-print">
            <div class="bg-stone-800 rounded-xl p-6 shadow-2xl border border-stone-700 min-h-[500px]">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-['Rye'] text-[#d6cfb8] uppercase tracking-wide">Registro de Termos</h2>
                    
                    <!-- Controles de Data -->
                    <div class="flex items-center bg-stone-900 p-1.5 rounded-lg border border-stone-600">
                        <button onclick="navigateHistoryDate(-1)" class="p-2 text-stone-400 hover:text-white hover:bg-stone-700 rounded transition-colors" title="Dia Anterior">
                            ‚¨ÖÔ∏è
                        </button>
                        <input type="date" id="history-date-filter" onchange="renderHistory()" class="bg-transparent text-stone-300 border-none focus:ring-0 text-sm font-sans px-2 mx-2">
                        <button onclick="navigateHistoryDate(1)" class="p-2 text-stone-400 hover:text-white hover:bg-stone-700 rounded transition-colors" title="Pr√≥ximo Dia">
                            ‚û°Ô∏è
                        </button>
                        <button onclick="resetDateFilter()" class="ml-2 text-[10px] text-stone-500 hover:text-stone-300 uppercase font-bold tracking-wider px-2 border-l border-stone-700">
                            Ver Todos
                        </button>
                    </div>
                </div>
                
                <!-- Input Oculto para Upload de PDF -->
                <input type="file" id="pdf-upload-input" accept="application/pdf" class="hidden">

                <div id="history-list" class="space-y-6">
                    <!-- O JS ir√° preencher isso -->
                </div>
            </div>
        </div>

    </div>

    <!-- O C√ìDIGO JAVASCRIPT PERMANECE INTACTO -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configura√ß√£o do Firebase fornecida
        const firebaseConfig = {
            apiKey: "AIzaSyAbf5-lB50j7YgEMpjHoFccUvHOOimAqGI",
            authDomain: "formulario-4e66d.firebaseapp.com",
            projectId: "formulario-4e66d",
            storageBucket: "formulario-4e66d.firebasestorage.app",
            messagingSenderId: "220835763298",
            appId: "1:220835763298:web:b81704cc0a3955b6022d3b",
            measurementId: "G-H1KNNPZ6H6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Estado global para manter o hist√≥rico em tempo real
        window.miplaceHistoryData = [];

        // Expondo fun√ß√µes para o escopo global (necess√°rio pois a tag <script> agora √© um module)
        window.validateAndPrint = validateAndPrint;
        window.validateAndSave = validateAndSave;
        window.navigateHistoryDate = navigateHistoryDate;
        window.resetDateFilter = resetDateFilter;
        window.renderHistory = renderHistory;
        window.printTermFromHistory = printTermFromHistory;
        window.triggerPdfUpload = triggerPdfUpload;

        // --- L√ìGICA DAS ABAS (TABS) E HIST√ìRICO ---
        
        const tabBtnNew = document.getElementById('tab-btn-new');
        const tabBtnHistory = document.getElementById('tab-btn-history');
        const tabContentNew = document.getElementById('tab-content-new');
        const tabContentHistory = document.getElementById('tab-content-history');

        tabBtnNew.addEventListener('click', () => {
            // Ativa bot√£o
            tabBtnNew.classList.remove('bg-stone-900', 'text-stone-500', 'border-stone-700');
            tabBtnNew.classList.add('bg-stone-800', 'text-[#d6cfb8]', 'border-[#d6cfb8]');
            
            // Desativa outro bot√£o
            tabBtnHistory.classList.remove('bg-stone-800', 'text-[#d6cfb8]', 'border-[#d6cfb8]');
            tabBtnHistory.classList.add('bg-stone-900', 'text-stone-500', 'border-stone-700');

            // Troca conte√∫do
            tabContentNew.classList.remove('hidden');
            tabContentHistory.classList.add('hidden');
        });

        tabBtnHistory.addEventListener('click', () => {
            // Ativa bot√£o
            tabBtnHistory.classList.remove('bg-stone-900', 'text-stone-500', 'border-stone-700');
            tabBtnHistory.classList.add('bg-stone-800', 'text-[#d6cfb8]', 'border-[#d6cfb8]');
            
            // Desativa outro bot√£o
            tabBtnNew.classList.remove('bg-stone-800', 'text-[#d6cfb8]', 'border-[#d6cfb8]');
            tabBtnNew.classList.add('bg-stone-900', 'text-stone-500', 'border-stone-700');

            // Troca conte√∫do
            tabContentHistory.classList.remove('hidden');
            tabContentNew.classList.add('hidden');
            
            renderHistory();
        });

        // --- HIST√ìRICO AVAN√áADO ---

        async function saveToHistory() {
            // Coleta dados dos inputs simples
            const inputs = {};
            document.querySelectorAll('input, select').forEach(el => {
                if(el.id) inputs[el.id] = el.value;
            });

            // Coleta acess√≥rios
            const accessories = [];
            document.querySelectorAll('.accessory-row').forEach(row => {
                const descInput = row.querySelector('.accessory-desc');
                const valInput = row.querySelector('.accessory-val');
                const finInput = row.querySelector('.accessory-fin');
                
                if(descInput && valInput && finInput) {
                    const desc = descInput.value;
                    const val = valInput.value;
                    const fin = finInput.value;
                    if(desc || val || fin) accessories.push({desc, val, fin});
                }
            });

            // Objeto para verifica√ß√£o de duplicidade (ignora ID e data de cria√ß√£o exata)
            const dataToCompare = {
                store: document.getElementById('purchase-location').value,
                customer: document.getElementById('buyer-name').value,
                device: document.getElementById('nf-model').value,
                type: document.getElementById('term-type').options[document.getElementById('term-type').selectedIndex].text,
                formData: inputs,
                accessories: accessories
            };
            
            // Busca o hist√≥rico atual (nuvem ou local)
            const historyToCheck = window.miplaceHistoryData && window.miplaceHistoryData.length > 0 
                            ? window.miplaceHistoryData 
                            : JSON.parse(localStorage.getItem('miplace_terms_history') || '[]');

            const currentCpf = inputs['cpf'] || '';
            const currentDateStr = document.getElementById('date').value || new Date().toLocaleDateString('pt-BR');

            // Verifica se j√° existe um registro id√™ntico (mesmo cliente, cpf, aparelho, loja e data)
            const isDuplicate = historyToCheck.some(item => {
                return item.customer === dataToCompare.customer &&
                       item.device === dataToCompare.device &&
                       item.store === dataToCompare.store &&
                       item.formattedDate === currentDateStr &&
                       item.formData && item.formData['cpf'] === currentCpf;
            });
            
            // Se encontrou duplicidade exata, interrompe e avisa
            if (isDuplicate) {
                return 'duplicate'; 
            }

            // Coleta dados principais para resumo
            const termData = {
                id: Date.now(),
                createdAt: new Date().toISOString(),
                formattedDate: currentDateStr,
                ...dataToCompare
            };

            try {
                // Salva no Firebase
                await addDoc(collection(db, 'termos_garantia'), termData);
                return 'cloud';
            } catch (error) {
                console.error("Erro ao salvar no Firebase, usando fallback local:", error);
                // Fallback para LocalStorage se Firebase falhar (Ex: sem internet)
                let history = JSON.parse(localStorage.getItem('miplace_terms_history') || '[]');
                history.unshift(termData); // Adiciona no topo
                localStorage.setItem('miplace_terms_history', JSON.stringify(history));
                return 'local';
            }
        }

        // Sincroniza√ß√£o em tempo real com Firebase
        onSnapshot(query(collection(db, 'termos_garantia')), (snapshot) => {
            const history = [];
            snapshot.forEach((doc) => {
                history.push({ fbId: doc.id, ...doc.data() });
            });
            // Ordena do mais recente para o mais antigo
            history.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
            
            window.miplaceHistoryData = history;
            localStorage.setItem('miplace_terms_history', JSON.stringify(history)); // Backup local
            
            // Atualiza a tela se a aba de hist√≥rico estiver aberta
            if (!document.getElementById('tab-content-history').classList.contains('hidden')) {
                renderHistory();
            }
        }, (error) => {
            console.error("Erro na sincroniza√ß√£o:", error);
            window.miplaceHistoryData = JSON.parse(localStorage.getItem('miplace_terms_history') || '[]');
        });

        // Fun√ß√µes de Navega√ß√£o de Data
        function navigateHistoryDate(offset) {
            const dateInput = document.getElementById('history-date-filter');
            // Se estiver vazio, assume hoje, sen√£o usa o valor atual corrigindo fuso hor√°rio
            let currentDate;
            if (dateInput.value) {
                const parts = dateInput.value.split('-');
                currentDate = new Date(parts[0], parts[1] - 1, parts[2]);
            } else {
                currentDate = new Date();
            }
            
            // Adiciona/Remove dias
            currentDate.setDate(currentDate.getDate() + offset);
            
            // Formata para YYYY-MM-DD
            const y = currentDate.getFullYear();
            const m = String(currentDate.getMonth() + 1).padStart(2, '0');
            const d = String(currentDate.getDate()).padStart(2, '0');
            
            dateInput.value = `${y}-${m}-${d}`;
            renderHistory();
        }

        function resetDateFilter() {
            document.getElementById('history-date-filter').value = '';
            renderHistory();
        }

        // Vari√°vel global para controlar qual termo est√° recebendo upload
        let currentUploadId = null;

        function renderHistory() {
            // Usa os dados do Firebase, com Fallback para o localStorage
            const history = window.miplaceHistoryData && window.miplaceHistoryData.length > 0 
                            ? window.miplaceHistoryData 
                            : JSON.parse(localStorage.getItem('miplace_terms_history') || '[]');
            const container = document.getElementById('history-list');
            const dateFilter = document.getElementById('history-date-filter').value;
            
            if (history.length === 0) {
                container.innerHTML = '<p class="text-stone-500 text-center italic mt-10">Nenhum termo gerado ainda.</p>';
                return;
            }

            let filteredHistory = history;

            // Filtro de Data
            if (dateFilter) {
                const [y, m, d] = dateFilter.split('-');
                const searchDate = `${d}/${m}/${y}`;
                filteredHistory = history.filter(item => item.formattedDate === searchDate);
                
                if (filteredHistory.length === 0) {
                     container.innerHTML = `<p class="text-stone-500 text-center italic mt-10">Nenhum termo encontrado para ${searchDate}.</p>`;
                     return;
                }
            }

            // Agrupamento por Data e Loja
            const groups = {};
            filteredHistory.forEach(item => {
                const dateKey = item.formattedDate;
                if (!groups[dateKey]) groups[dateKey] = {};
                
                const storeKey = item.store || 'Loja n√£o selecionada';
                if (!groups[dateKey][storeKey]) groups[dateKey][storeKey] = [];
                
                groups[dateKey][storeKey].push(item);
            });

            let html = '';
            for (const date in groups) {
                html += `<div class="mb-8 bg-stone-900/50 p-4 rounded-lg border border-stone-700">
                    <h3 class="text-xl font-bold text-[#d6cfb8] border-b border-stone-600 pb-2 mb-4 font-['Rye']">üìÖ ${date}</h3>`;
                
                for (const store in groups[date]) {
                     const storeShort = store.split(',')[0];
                     const logoUrl = (typeof logoMap !== 'undefined' && logoMap[store]) ? logoMap[store] : "https://placehold.co/120x80/d1d5db/4b5563?text=Logo";
                     
                     html += `<div class="ml-2 mb-6">
                        <h4 class="text-sm font-bold text-stone-400 mb-3 uppercase tracking-widest flex items-center gap-3">
                            <img src="${logoUrl}" class="w-8 h-8 rounded-full border border-stone-600 object-cover bg-white">
                            ${storeShort}
                        </h4>
                        <div class="overflow-x-auto rounded-lg border border-stone-700">
                            <table class="w-full text-sm text-left text-stone-300">
                                <thead class="text-xs text-stone-400 uppercase bg-stone-800">
                                    <tr>
                                        <th class="px-4 py-3">Cliente</th>
                                        <th class="px-4 py-3">Aparelho</th>
                                        <th class="px-4 py-3">Tipo de Termo</th>
                                        <th class="px-4 py-3 text-center">Arquivo</th>
                                        <th class="px-4 py-3 text-center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                     
                     groups[date][store].forEach(item => {
                        const hasPdf = !!item.signedPdf;
                        
                        html += `<tr class="border-b border-stone-700 hover:bg-stone-800/80 transition-colors">
                            <td class="px-4 py-3 font-medium text-white font-['Caveat'] text-lg">${item.customer || 'Sem nome'}</td>
                            <td class="px-4 py-3">${item.device || '-'}</td>
                            <td class="px-4 py-3 text-xs uppercase tracking-wide text-stone-500">${item.type}</td>
                            <td class="px-4 py-3 text-center">
                                <button onclick="printTermFromHistory(${item.id})" class="text-stone-400 hover:text-green-400 transition-colors text-xl flex items-center justify-center mx-auto gap-1" title="${hasPdf ? 'Imprimir PDF Assinado' : 'Imprimir Termo Gerado'}">
                                    ${hasPdf ? 'üìÑ<span class="text-[10px] text-green-400 ml-1">PDF</span>' : 'üìÑ'}
                                </button>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <button onclick="triggerPdfUpload(${item.id})" class="text-stone-400 hover:text-blue-400 transition-colors text-lg" title="${hasPdf ? 'Substituir PDF Assinado' : 'Anexar PDF Assinado'}">
                                    ${hasPdf ? '‚úÖ' : 'üìé'}
                                </button>
                            </td>
                        </tr>`;
                     });

                     html += `</tbody></table></div></div>`;
                }
                html += `</div>`;
            }
            container.innerHTML = html;
        }

        // Fun√ß√£o para acionar o upload
        function triggerPdfUpload(id) {
            currentUploadId = id;
            document.getElementById('pdf-upload-input').click();
        }

        // Listener para o input de arquivo
        document.getElementById('pdf-upload-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                alert('Apenas arquivos PDF s√£o permitidos.');
                return;
            }

            // Limite de seguran√ßa reduzido para ~700KB para obedecer o limite de 1MB por documento do Firebase
            if (file.size > 700 * 1024) {
                alert('O arquivo √© muito grande (M√°x 700KB). Por limita√ß√µes do banco de dados (Firebase), reduza o tamanho do PDF.');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(event) {
                const base64String = event.target.result;
                
                try {
                    const history = window.miplaceHistoryData && window.miplaceHistoryData.length > 0 
                                    ? window.miplaceHistoryData 
                                    : JSON.parse(localStorage.getItem('miplace_terms_history') || '[]');
                    const itemIndex = history.findIndex(item => item.id === currentUploadId);
                    
                    if (itemIndex !== -1) {
                        const item = history[itemIndex];
                        if (item.fbId) {
                            // Salva no Firebase
                            await updateDoc(doc(db, 'termos_garantia', item.fbId), { signedPdf: base64String });
                            alert('‚úÖ PDF anexado com sucesso no Firebase!');
                        } else {
                            // Fallback LocalStorage
                            history[itemIndex].signedPdf = base64String;
                            localStorage.setItem('miplace_terms_history', JSON.stringify(history));
                            renderHistory();
                            alert('‚úÖ PDF anexado com sucesso localmente!');
                        }
                    }
                } catch (error) {
                    console.error(error);
                    alert('‚ùå Erro ao salvar PDF. Verifique sua conex√£o ou limite de armazenamento do Firebase.');
                }
                
                // Limpa o input para permitir selecionar o mesmo arquivo novamente se necess√°rio
                document.getElementById('pdf-upload-input').value = '';
                currentUploadId = null;
            };
            
            reader.readAsDataURL(file);
        });

        function loadTermFromHistory(id) {
            const history = window.miplaceHistoryData && window.miplaceHistoryData.length > 0 
                            ? window.miplaceHistoryData 
                            : JSON.parse(localStorage.getItem('miplace_terms_history') || '[]');
            const term = history.find(t => t.id === id);
            
            if(!term) return;

            document.getElementById('tab-btn-new').click();
            const accessoriesContainer = document.getElementById('accessories-container');
            accessoriesContainer.innerHTML = ''; 

            if(term.formData) {
                // Restaura Tipo e Loja primeiro
                if(term.formData['term-type']) {
                    const el = document.getElementById('term-type');
                    el.value = term.formData['term-type'];
                    el.dispatchEvent(new Event('change'));
                }
                if(term.formData['purchase-location']) {
                    const el = document.getElementById('purchase-location');
                    el.value = term.formData['purchase-location'];
                    el.dispatchEvent(new Event('change'));
                }
                
                // Restaura o restante
                for(const key in term.formData) {
                    if(key === 'term-type' || key === 'purchase-location') continue;
                    const el = document.getElementById(key);
                    if(el) {
                        el.value = term.formData[key];
                        el.dispatchEvent(new Event('input'));
                    }
                }
            }
            
            if(term.accessories && term.accessories.length > 0) {
                term.accessories.forEach(acc => {
                    addAccessoryRow();
                    const rows = accessoriesContainer.querySelectorAll('.accessory-row');
                    const lastRow = rows[rows.length-1];
                    if(lastRow) {
                        lastRow.querySelector('.accessory-desc').value = acc.desc;
                        lastRow.querySelector('.accessory-val').value = acc.val;
                        lastRow.querySelector('.accessory-fin').value = acc.fin;
                    }
                });
            }
            
            // Rola para o topo para mostrar o termo preenchido
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Feedback visual
            const tabBtnNew = document.getElementById('tab-btn-new');
            tabBtnNew.classList.add('ring-2', 'ring-[#d6cfb8]');
            setTimeout(() => tabBtnNew.classList.remove('ring-2', 'ring-[#d6cfb8]'), 1000);
        }

        function printTermFromHistory(id) {
            const history = window.miplaceHistoryData && window.miplaceHistoryData.length > 0 
                            ? window.miplaceHistoryData 
                            : JSON.parse(localStorage.getItem('miplace_terms_history') || '[]');
            const term = history.find(t => t.id === id);

            if (term && term.signedPdf) {
                // Se tiver PDF assinado, abre o PDF
                const win = window.open();
                win.document.write(`<iframe src="${term.signedPdf}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
                win.document.title = `Termo Assinado - ${term.customer}`;
            } else {
                // Se n√£o, carrega os dados e imprime o formul√°rio HTML
                loadTermFromHistory(id);

                // Aguarda um pequeno intervalo para garantir que o DOM foi atualizado
                setTimeout(() => {
                    window.print();
                }, 500);
            }
        }

        async function deleteHistoryItem(id) {
            if(confirm('Tem certeza que deseja excluir este registro?')) {
                const history = window.miplaceHistoryData || JSON.parse(localStorage.getItem('miplace_terms_history') || '[]');
                const item = history.find(t => t.id === id);
                
                if (item && item.fbId) {
                    try {
                        await deleteDoc(doc(db, 'termos_garantia', item.fbId));
                    } catch (e) {
                        console.error("Erro ao deletar do Firebase", e);
                    }
                } else {
                    let localHistory = JSON.parse(localStorage.getItem('miplace_terms_history') || '[]');
                    localHistory = localHistory.filter(i => i.id !== id);
                    localStorage.setItem('miplace_terms_history', JSON.stringify(localHistory));
                    renderHistory();
                }
            }
        }

        function clearHistory() {
            if(confirm('Tem certeza que deseja apagar TODO o hist√≥rico local? Os dados do Firebase n√£o ser√£o apagados por seguran√ßa.')) {
                localStorage.removeItem('miplace_terms_history');
                renderHistory();
            }
        }

        // --- FIM DA L√ìGICA DE ABAS ---


        // Fun√ß√£o para formatar a data (mantida)
        function formatDate(dateInput) {
            let value = dateInput.value.replace(/\D/g, '');
            if (value.length > 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length > 5) {
                value = value.substring(0, 5) + '/' + value.substring(5, 9);
            }
            dateInput.value = value;
        }

        // Fun√ß√£o para formatar Moeda
        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, '');
            
            if (value === '') {
                input.value = '';
                return;
            }
            
            let number = parseFloat(value) / 100;
            input.value = number.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        // Fun√ß√£o para formatar telefone
        function formatPhone(phoneInput) {
            let value = phoneInput.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length > 2) {
                value = '(' + value.substring(0, 2) + ') ' + value.substring(2);
            }
            if (value.length > 9) {
                value = value.substring(0, 9) + '-' + value.substring(9);
            }
            phoneInput.value = value;
        }

        // Fun√ß√£o para formatar o CPF
        function formatCPF(cpfInput) {
            let value = cpfInput.value.replace(/\D/g, ''); // Remove tudo que n√£o for n√∫mero
            if (value.length > 11) value = value.slice(0, 11); // Limita a 11 d√≠gitos (sem contar pontos/tra√ßo)
            
            // Aplica a formata√ß√£o XXX.XXX.XXX-XX progressivamente
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            
            cpfInput.value = value;
            cpfInput.classList.remove('invalid-field'); // Limpa o alerta vermelho se o usu√°rio come√ßar a corrigir
        }

        // Fun√ß√£o para validar matematicamente o CPF
        function isValidCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g, ''); // Remove a formata√ß√£o para c√°lculo
            
            // Rejeita CPFs com tamanho errado ou de n√∫meros repetidos viciados
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false; 

            let soma = 0;
            let resto;

            // Valida√ß√£o do primeiro d√≠gito
            for (let i = 1; i <= 9; i++) soma = soma + parseInt(cpf.substring(i - 1, i)) * (11 - i);
            resto = (soma * 10) % 11;
            if ((resto === 10) || (resto === 11)) resto = 0;
            if (resto !== parseInt(cpf.substring(9, 10))) return false;

            soma = 0;
            // Valida√ß√£o do segundo d√≠gito
            for (let i = 1; i <= 10; i++) soma = soma + parseInt(cpf.substring(i - 1, i)) * (12 - i);
            resto = (soma * 10) % 11;
            if ((resto === 10) || (resto === 11)) resto = 0;
            if (resto !== parseInt(cpf.substring(10, 11))) return false;

            return true;
        }

        // Fun√ß√£o para formatar CEP
        function formatCEP(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 8);
            }
            input.value = value;
        }

        // --- L√ìGICA DE SELE√á√ÉO DO TIPO DE TERMO ---
        const termTypeSelect = document.getElementById('term-type');
        const contentStandard = document.getElementById('content-standard');
        const contentIphone = document.getElementById('content-iphone');
        const contentSeminovo = document.getElementById('content-seminovo');
        const mainTitle = document.getElementById('main-title');
        const declarationText = document.getElementById('declaration-text');
        const nfBrandSelect = document.getElementById('nf-brand');
        
        // Elementos de entrada (para preencher o texto din√¢mico)
        const buyerNameInput = document.getElementById('buyer-name');
        const cpfInput = document.getElementById('cpf');

        function updateTermContent() {
            const selectedType = termTypeSelect.value;
            const name = buyerNameInput.value || "__________";
            const cpf = cpfInput.value || "__________";
            const currentBrand = nfBrandSelect.value;

            // Esconde todos inicialmente
            contentStandard.classList.add('hidden');
            contentIphone.classList.add('hidden');
            contentSeminovo.classList.add('hidden');

            // --- L√≥gica Condicional da Marca ---
            nfBrandSelect.innerHTML = ''; // Limpa as op√ß√µes atuais
            if (selectedType === 'iphone' || selectedType === 'seminovo') {
                // Modo Apple (Apenas iPhone, auto-selecionado)
                const option = document.createElement('option');
                option.value = 'Iphone';
                option.textContent = 'Iphone';
                nfBrandSelect.appendChild(option);
                nfBrandSelect.value = 'Iphone';
            } else {
                // Modo Android (Oculta iPhone)
                const androidBrands = ["Honor", "Motorola", "Poco", "Realme", "Redmi", "Samsung"];
                nfBrandSelect.innerHTML = '<option value="">Selecione...</option>';
                androidBrands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    nfBrandSelect.appendChild(option);
                });
                // Mant√©m a sele√ß√£o anterior se for uma marca Android v√°lida
                if (androidBrands.includes(currentBrand)) {
                    nfBrandSelect.value = currentBrand;
                }
            }

            if (selectedType === 'iphone') {
                // Modo iPhone Lacrado
                contentIphone.classList.remove('hidden');
                mainTitle.textContent = "TERMO DE GARANTIA - IPHONE LACRADO";
                
                // Declara√ß√£o Espec√≠fica iPhone Lacrado
                declarationText.innerHTML = `
                    <p class="mb-2">Eu, <span class="font-['Caveat'] text-2xl">${name}</span>, CPF <span class="font-['Caveat'] text-2xl">${cpf}</span>, confirmo que li e compreendi os termos acima.</p>
                    <p>Declaro que recebi o iPhone <strong>NOVO E LACRADO</strong>, com a embalagem intacta. Estou ciente de que a garantia √© de <strong>01 (um) ano diretamente com a Apple</strong>.</p>
                `;
            } else if (selectedType === 'seminovo') {
                // Modo iPhone Semi-novo
                contentSeminovo.classList.remove('hidden');
                mainTitle.textContent = "TERMO DE GARANTIA - IPHONE SEMI-NOVO";

                // Declara√ß√£o Espec√≠fica iPhone Semi-novo
                declarationText.innerHTML = `
                    <p class="mb-2">Eu, <span class="font-['Caveat'] text-2xl">${name}</span>, CPF <span class="font-['Caveat'] text-2xl">${cpf}</span>, confirmo que li e compreendi integralmente os termos desta garantia limitada de 90 (noventa) dias.</p>
                    <p class="text-justify">Declaro estar expressamente ciente de que o iPhone adquirido √© <strong>SEMI-NOVO</strong> e, portanto, pode ter passado por manuten√ß√µes pr√©vias ou possuir pe√ßas substitu√≠das, tendo sido testado e aprovado funcionalmente pela loja. Confirmo que recebo o aparelho em pleno funcionamento.</p>
                `;
            } else {
                // Modo Padr√£o
                contentStandard.classList.remove('hidden');
                mainTitle.textContent = "TERMO DE GARANTIA LEGAL";

                // Declara√ß√£o Padr√£o
                declarationText.innerHTML = `
                    Eu, <span class="font-['Caveat'] text-2xl">${name}</span>, CPF <span class="font-['Caveat'] text-2xl">${cpf}</span>, confirmo que li e compreendi os termos desta garantia e que o aparelho adquirido encontra-se em pleno funcionamento no momento da compra.
                `;
            }
        }

        // Listener para mudan√ßa no select
        termTypeSelect.addEventListener('change', updateTermContent);

        // Listeners para atualizar o nome/cpf em tempo real na declara√ß√£o
        buyerNameInput.addEventListener('input', updateTermContent);
        cpfInput.addEventListener('input', () => {
            formatCPF(cpfInput); // Agora aplica a m√°scara de pontos e tra√ßo no campo principal em tempo real!
            updateTermContent();
        });

        // Inicializa o conte√∫do correto ao carregar
        updateTermContent();

        // --- FIM L√ìGICA DE SELE√á√ÉO ---

        // Fun√ß√£o para limpar todos os campos
        function clearFields() {
            // Seleciona tanto campos required quanto os novos da NF
            const fields = document.querySelectorAll('.js-required, input[id^="nf-"], select[id^="nf-"]');
            fields.forEach(field => {
                field.value = '';
                field.classList.remove('invalid-field');
            });
            document.getElementById('validation-message').classList.add('hidden');
            updateTermContent(); // Atualiza o texto de confirma√ß√£o com os campos vazios
            
            // Reseta as informa√ß√µes da loja para o padr√£o
            document.getElementById('miplace-info').textContent = 'MiPlace';
            document.getElementById('support-phone').textContent = '';
            
            // Reseta o logo para o padr√£o
            document.getElementById('logo-image').src = "https://placehold.co/120x80/d1d5db/4b5563?text=Logo";
            
            // Reseta o input e datalist "Conheceu a loja"
            const howKnewInput = document.getElementById('how-knew');
            const howKnewDatalist = document.getElementById('how-knew-options');
            const displayHowKnew = document.getElementById('display-how-knew');
            howKnewInput.value = '';
            howKnewInput.disabled = true;
            howKnewInput.placeholder = "Selecione a loja primeiro";
            if(howKnewDatalist) howKnewDatalist.innerHTML = '';
            if(displayHowKnew) displayHowKnew.value = '';

            // Limpa todos os acess√≥rios din√¢micos
            document.getElementById('accessories-container').innerHTML = '';
        }

        // Fun√ß√£o para validar e salvar (sem imprimir)
        async function validateAndSave() {
            const fields = document.querySelectorAll('.js-required');
            let allFieldsFilled = true;
            let cpfValido = true;

            fields.forEach(field => field.classList.remove('invalid-field'));

            fields.forEach(field => {
                if (field.value.trim() === '') {
                    field.classList.add('invalid-field');
                    allFieldsFilled = false;
                }
            });

            const cpf1 = document.getElementById('cpf');
            const cpf2 = document.getElementById('nf-cpf');

            if (cpf1 && cpf1.value.trim() !== '' && !isValidCPF(cpf1.value)) {
                cpf1.classList.add('invalid-field');
                cpfValido = false;
            }
            if (cpf2 && cpf2.value.trim() !== '' && !isValidCPF(cpf2.value)) {
                cpf2.classList.add('invalid-field');
                cpfValido = false;
            }

            const validationMessage = document.getElementById('validation-message');
            
            if (allFieldsFilled && cpfValido) {
                validationMessage.classList.add('hidden');
                
                // Feedback visual de carregamento no bot√£o
                const btnSave = document.querySelector('button[onclick="validateAndSave()"]');
                const originalText = btnSave.innerHTML;
                btnSave.innerHTML = '‚è≥ Salvando...';
                btnSave.disabled = true;

                const saveResult = await saveToHistory();
                renderHistory(); // Atualiza a lista imediatamente
                
                // Restaura o bot√£o
                btnSave.innerHTML = originalText;
                btnSave.disabled = false;

                if (saveResult === 'duplicate') {
                    alert('‚ö†Ô∏è Este termo j√° est√° salvo no hist√≥rico de hoje! Se for uma nova venda, altere os dados (ex: Cliente, Aparelho ou CPF).');
                } else if (saveResult === 'cloud') {
                    alert('‚òÅÔ∏è‚úÖ Termo salvo com sucesso na Nuvem!');
                    clearFields();
                } else {
                    alert('üíæ‚úÖ Sem conex√£o: Termo salvo apenas no Hist√≥rico Local.');
                    clearFields();
                }
            } else {
                validationMessage.classList.remove('hidden');
                if (!allFieldsFilled) {
                    validationMessage.innerHTML = '‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios para salvar.';
                } else {
                    validationMessage.innerHTML = '‚ö†Ô∏è O CPF informado √© inv√°lido.';
                }
                window.scrollTo(0, 0);
            }
        }

        // Fun√ß√£o para validar e imprimir
        async function validateAndPrint() {
            const fields = document.querySelectorAll('.js-required');
            let allFieldsFilled = true;
            let cpfValido = true;

            // Limpa a formata√ß√£o de erro anterior
            fields.forEach(field => {
                field.classList.remove('invalid-field');
            });

            // Verifica cada campo
            fields.forEach(field => {
                if (field.value.trim() === '') {
                    field.classList.add('invalid-field');
                    allFieldsFilled = false;
                }
            });

            // Valida os CPFs espec√≠ficos se eles estiverem preenchidos
            const cpf1 = document.getElementById('cpf');
            const cpf2 = document.getElementById('nf-cpf');

            if (cpf1 && cpf1.value.trim() !== '' && !isValidCPF(cpf1.value)) {
                cpf1.classList.add('invalid-field');
                cpfValido = false;
            }
            if (cpf2 && cpf2.value.trim() !== '' && !isValidCPF(cpf2.value)) {
                cpf2.classList.add('invalid-field');
                cpfValido = false;
            }

            const validationMessage = document.getElementById('validation-message');
            if (allFieldsFilled && cpfValido) {
                validationMessage.classList.add('hidden');
                // Salva automaticamente ao imprimir para garantir registro (aguarda conclus√£o)
                await saveToHistory();
                renderHistory();
                
                // Aguarda um breve momento para garantir que o salvamento ocorreu antes de travar a thread com print
                setTimeout(() => {
                    window.print();
                    clearFields();
                }, 100);
            } else {
                validationMessage.classList.remove('hidden');
                // Altera a mensagem de erro dinamicamente dependendo de qual for a falha
                if (!allFieldsFilled) {
                    validationMessage.innerHTML = '‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios para poder imprimir.';
                } else if (!cpfValido) {
                    validationMessage.innerHTML = '‚ö†Ô∏è O CPF informado √© inv√°lido. Verifique se os n√∫meros est√£o corretos.';
                }
                // Rola para o topo do formul√°rio para exibir a mensagem de erro
                window.scrollTo(0, 0);
            }
        }

        // Event listener para o campo de data
        const dateInput = document.getElementById('date');
        dateInput.addEventListener('keyup', () => formatDate(dateInput));
        
        // --- Novos Event Listeners para a se√ß√£o NF ---
        const nfBirthMainInput = document.getElementById('nf-birthdate-main');
        nfBirthMainInput.addEventListener('keyup', () => formatDate(nfBirthMainInput));

        // Listener para o novo campo Data da Compra
        const nfPurchaseDateInput = document.getElementById('nf-purchase-date');
        nfPurchaseDateInput.addEventListener('keyup', () => formatDate(nfPurchaseDateInput));

        const nfBuyerPhoneInput = document.getElementById('nf-buyer-phone');
        nfBuyerPhoneInput.addEventListener('input', () => formatPhone(nfBuyerPhoneInput));

        const nfCpfInput = document.getElementById('nf-cpf');
        nfCpfInput.addEventListener('input', () => formatCPF(nfCpfInput));

        const nfImeiInput = document.getElementById('nf-imei');
        nfImeiInput.addEventListener('input', () => {
            let value = nfImeiInput.value.replace(/\D/g, ''); // Remove tudo que n√£o for n√∫mero
            if (value.length > 15) value = value.slice(0, 15); // Limita a 15 d√≠gitos
            nfImeiInput.value = value;
        });

        // Valida√ß√£o imediata de CPF ao perder o foco da caixa de texto (blur)
        function handleCpfBlur(event) {
            const input = event.target;
            if (input.value.length > 0 && !isValidCPF(input.value)) {
                input.classList.add('invalid-field');
            }
        }
        cpfInput.addEventListener('blur', handleCpfBlur);
        nfCpfInput.addEventListener('blur', handleCpfBlur);

        // Adiciona o listener para o campo de Valor do Aparelho
        const nfValueInput = document.getElementById('nf-value');
        nfValueInput.addEventListener('input', () => formatCurrency(nfValueInput));

        // --- L√≥gica de Acess√≥rios Din√¢micos ---
        const accessoriesContainer = document.getElementById('accessories-container');
        const addAccessoryBtn = document.getElementById('add-accessory-btn');

        function addAccessoryRow() {
            const row = document.createElement('div');
            // Nota: Adicionado print:grid-cols-12 para manter os campos lado a lado na impress√£o
            row.className = 'grid grid-cols-1 md:grid-cols-12 print:grid-cols-12 gap-4 items-end accessory-row pb-4 border-b border-stone-400 border-dashed md:border-none md:pb-0 relative';
            
            row.innerHTML = `
                <div class="flex flex-col md:col-span-6 print:col-span-6">
                    <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Descri√ß√£o</label>
                    <input type="text" class="vintage-input w-full js-required accessory-desc" placeholder="Ex: Pel√≠cula, Capa">
                </div>
                <div class="flex flex-col md:col-span-3 print:col-span-3">
                    <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Valor Total</label>
                    <input type="text" placeholder="R$ 0,00" class="vintage-input w-full js-required accessory-val">
                </div>
                <div class="flex flex-col md:col-span-3 print:col-span-3">
                    <label class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-1">Financiado</label>
                    <select class="vintage-input w-full js-required cursor-pointer accessory-fin">
                        <option value="">Selecione...</option>
                        <option value="Sim">Sim</option>
                        <option value="N√£o">N√£o</option>
                    </select>
                </div>
                <div class="flex flex-col md:col-span-1 print:hidden pb-1 no-print text-center justify-end h-full absolute top-0 right-0 md:relative">
                    <button type="button" class="text-stone-400 hover:text-red-700 font-bold text-lg remove-accessory-btn transition-colors" title="Remover Acess√≥rio">‚úñ</button>
                </div>
            `;

            // Formata√ß√£o de moeda em tempo real para este input rec√©m-criado
            const valInput = row.querySelector('.accessory-val');
            valInput.addEventListener('input', () => formatCurrency(valInput));

            // L√≥gica de remover a linha
            const removeBtn = row.querySelector('.remove-accessory-btn');
            removeBtn.addEventListener('click', () => {
                row.remove();
            });

            accessoriesContainer.appendChild(row);
        }

        addAccessoryBtn.addEventListener('click', addAccessoryRow);
        // --- Fim L√≥gica de Acess√≥rios ---

        // Fun√ß√£o ass√≠ncrona para buscar os dados do CEP e autopreencher o endere√ßo
        async function fetchAddress(cep) {
            const cleanCep = cep.replace(/\D/g, '');
            if (cleanCep.length === 8) {
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);
                    const data = await response.json();
                    
                    if (!data.erro) {
                        const addressInput = document.getElementById('nf-address');
                        const neighborhoodInput = document.getElementById('nf-neighborhood');
                        const cityInput = document.getElementById('nf-city');
                        
                        // Preenche os campos da segunda p√°gina
                        addressInput.value = data.logradouro || '';
                        neighborhoodInput.value = data.bairro || '';
                        cityInput.value = data.localidade ? data.localidade + ' - ' + data.uf : '';
                        
                        // Remove a marca√ß√£o de erro caso o usu√°rio tivesse tentado imprimir antes
                        addressInput.classList.remove('invalid-field');
                        neighborhoodInput.classList.remove('invalid-field');
                        cityInput.classList.remove('invalid-field');

                        // Pula o cursor automaticamente para o campo de n√∫mero
                        document.getElementById('nf-number').focus();
                    }
                } catch (error) {
                    console.error("Erro ao buscar o CEP:", error);
                }
            }
        }

        // Adiciona o listener para o campo de CEP na P√°gina da NF
        const nfZipcodeInput = document.getElementById('nf-zipcode');
        
        // Formata CEP e busca endere√ßo se modificado na p√°gina 2
        nfZipcodeInput.addEventListener('input', () => {
            formatCEP(nfZipcodeInput);
            nfZipcodeInput.classList.remove('invalid-field');
            if (nfZipcodeInput.value.length === 9) fetchAddress(nfZipcodeInput.value);
        });
        
        // Bot√£o para preencher a data atual
        document.getElementById('fill-date-btn').addEventListener('click', () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${day}/${month}/${year}`;
            
            dateInput.value = formattedDate;
            // Preenche automaticamente tamb√©m a Data da Compra na se√ß√£o da NF
            nfPurchaseDateInput.value = formattedDate;
        });
        
        // Sincroniza√ß√£o autom√°tica opcional:
        // Se desejar que o Nome e CPF de cima preencham os de baixo automaticamente
        buyerNameInput.addEventListener('input', () => {
            document.getElementById('nf-buyer-name').value = buyerNameInput.value;
        });
        
        cpfInput.addEventListener('input', () => {
            const nfCpf = document.getElementById('nf-cpf');
            nfCpf.value = cpfInput.value;
            // Se o CPF inserido for validado e estiver sincronizado, remove erro do campo de baixo tamb√©m
            if (isValidCPF(cpfInput.value)) {
                nfCpf.classList.remove('invalid-field');
            }
        });

        // Sincroniza o campo "Conheceu a Loja" com a exibi√ß√£o perto da assinatura
        const howKnewGlobalInput = document.getElementById('how-knew');
        howKnewGlobalInput.addEventListener('input', () => {
            document.getElementById('display-how-knew').value = howKnewGlobalInput.value;
        });

        // Bot√£o para limpar campos
        document.getElementById('clear-btn').addEventListener('click', clearFields);

        // Obt√©m os elementos para exibir a localiza√ß√£o e o telefone
        const purchaseLocationSelect = document.getElementById('purchase-location');
        const miplaceInfo = document.getElementById('miplace-info');
        const supportPhoneSpan = document.getElementById('support-phone');

        // Mapa de telefones por local de compra
        const phoneMap = {
            "Miplace Honor, Rua Dom Pedro II, 857 centro Piracicaba CNPJ 34511185/0001-10": "(19) 99497-5131 - Miplace Honor CNPJ 34.511.185/0001-10",
            "Miplace Realme, Rua Benjamin Constant, 1230 centro Piracicaba CNPJ 44739622/0001-01": "(19) 99451-0123 - Miplace Realme CNPJ 44.739.622/0001-01",
            "Miplace XV, Rua XV de Novembro, 910 centro Piracicaba CNPJ 13787408/0001-05": "(19) 99152-2724 - Miplace XV CNPJ 13.787.408/0001-05",
            "Miplace Premium, Rua Treze de Maio, 26 centro Amparo CNPJ 58186781/0001-30": "(19) 99961-8865 - Miplace Premium CNPJ 58.186.781/0001-30 ",
            "Miplace Kassouf, Rua Treze de Maio 218 Sala 9, centro Amparo CNPJ 58495100/0001-16": "(19) 97107-7066 - Miplace Kassouf CNPJ 58.495.100/0001-16"
        };
        
        // Mapa de logos por local de compra, com URLs acess√≠veis
        const logoMap = {
            "Miplace Honor, Rua Dom Pedro II, 857 centro Piracicaba CNPJ 34511185/0001-10": "dp (1).jpg",
            "Miplace Realme, Rua Benjamin Constant, 1230 centro Piracicaba CNPJ 44739622/0001-01": "realme (1).jpg",
            "Miplace XV, Rua XV de Novembro, 910 centro Piracicaba CNPJ 13787408/0001-05": "xv (1).jpg",
            "Miplace Premium, Rua Treze de Maio, 26 centro Amparo CNPJ 58186781/0001-30": "pr (1).jpg",
            "Miplace Kassouf, Rua Treze de Maio 218 Sala 9, centro Amparo CNPJ 58495100/0001-16": "kf (1).jpg"
        };

        // Mapa de op√ß√µes para "Conheceu a loja" baseado no local
        const howKnewMap = {
            "Miplace Honor, Rua Dom Pedro II, 857 centro Piracicaba CNPJ 34511185/0001-10": ["Cliente Loja", "Cliente Rua", "Facebook", "Google", "Tiktok", "Jack", "Daia", "Tati", "Jenifer", "Gabriel", "Ana Carvalho", "Bia vendedora", "Ana vendedora", "Davison gerente", "Pastor Everaldo", "Diogenes", "Igor (Bia Gomes)", "Fam√≠lia", "Ricardo (Ana Reina)", "Ana Cerqueira", "Viviane Cybelar", "Instagram"],
            "Miplace Realme, Rua Benjamin Constant, 1230 centro Piracicaba CNPJ 44739622/0001-01": ["Cliente Loja", "Cliente Rua", "Facebook", "Google", "Tiktok", "Jack", "Bruno vendedor", "Joj√¥", "Gustavo Carvalho", "Ana Carvalho", "Hemilly", "Kell vendedora", "Lidia vendedora", "Instagram"],
            "Miplace XV, Rua XV de Novembro, 910 centro Piracicaba CNPJ 13787408/0001-05": ["Cliente Loja", "Cliente Rua", "Facebook", "Google", "Tiktok", "Jack", "Fabi gerente", "Polly vendedora", "Filipe vendedor", "Ana Carvalho", "Pri Almeida", "Tamires", "Instagram"],
            "Miplace Premium, Rua Treze de Maio, 26 centro Amparo CNPJ 58186781/0001-30": ["Cliente Loja", "Cliente Rua", "Facebook", "Google", "Tiktok", "Jack", "Sabrina gerente", "Giovane gerente", "Bianca vendedora", "Andressa vendedora", "Gaby vendedora", "Fabio Almeida", "Pri Almeida", "Pri Negr√£o", "Instagram"],
            "Miplace Kassouf, Rua Treze de Maio 218 Sala 9, centro Amparo CNPJ 58495100/0001-16": ["Cliente Loja", "Cliente Rua", "Facebook", "Google", "Tiktok", "Jack", "Sabrina gerente", "Giovane gerente", "Bianca vendedora", "Andressa vendedora", "Gaby vendedor", "Fabio Almeida", "Pri Almeida", "Pri Negr√£o", "Instagram"]
        };

        // Event listener para o campo de sele√ß√£o de local de compra
        purchaseLocationSelect.addEventListener('change', () => {
            const selectedValue = purchaseLocationSelect.value;
            const selectedText = purchaseLocationSelect.options[purchaseLocationSelect.selectedIndex].text;
            const logoImage = document.getElementById('logo-image');
            const howKnewInput = document.getElementById('how-knew');
            const howKnewDatalist = document.getElementById('how-knew-options');

            // Atualiza o nome da loja no termo de garantia
            if (selectedText === "Selecione o local da compra") {
                miplaceInfo.textContent = 'MiPlace';
            } else {
                miplaceInfo.textContent = selectedText;
            }

            // Atualiza o telefone de contato com base no mapa
            const newPhoneNumber = phoneMap[selectedValue];
            if (newPhoneNumber) {
                supportPhoneSpan.textContent = newPhoneNumber;
            } else {
                // Se nenhuma loja v√°lida for selecionada, remove o n√∫mero de telefone.
                supportPhoneSpan.textContent = '';
            }

            // Atualiza o logo com base no mapa
            if (logoMap[selectedValue]) {
                logoImage.src = logoMap[selectedValue];
            } else {
                logoImage.src = "https://placehold.co/120x80/d1d5db/4b5563?text=Logo";
            }
            
            // Popula as op√ß√µes do campo "Conheceu a loja" condicionalmente
            howKnewDatalist.innerHTML = ''; // Limpa as op√ß√µes
            howKnewInput.value = ''; // Limpa o texto atual
            document.getElementById('display-how-knew').value = ''; // Sincroniza a limpeza na parte de baixo
            
            if (howKnewMap[selectedValue]) {
                howKnewMap[selectedValue].forEach(optionText => {
                    const option = document.createElement('option');
                    option.value = optionText;
                    howKnewDatalist.appendChild(option);
                });
                howKnewInput.disabled = false;
                howKnewInput.placeholder = "Selecione ou digite...";
            } else {
                howKnewInput.disabled = true;
                howKnewInput.placeholder = "Selecione a loja primeiro";
            }
        });
    </script>
</body>
</html>